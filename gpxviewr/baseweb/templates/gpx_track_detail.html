{% extends "base.html" %}
{% block opengraph %}
<meta property="og:title" content="GPXViewr - {{object.name}}"/>
<meta name="description" property="og:description" content="GPX Track Viewer with POI search based on OpenStreetMap"/>
<meta property="og:type" content="website"/>
<meta property="og:image" content="https://gpxviewr.genannt.name/static/preview.png"/>

<style>
    .flyover {
        left: 150%;
        overflow: hidden;
        position: fixed;
        width: 50%;
        opacity: 0.95;
        z-index: 1050;
        transition: left 0.6s ease-out 0s;
     }
      
     .flyover-centered {
        top: 50%;
        transform: translate(-50%, -50%);
     }
     
     .flyover.in {
        left: 50%;
     }
    .nolinkcolor {
        text-decoration: none;
    }
    .elevation_hide_show_shake {
        /* Start the shake animation and make the animation last for 0.5 seconds */
        animation: shake 2.5s;
      
        /* When the animation is finished, start again */
        //animation-iteration-count: infinite;
      }
      
      @keyframes shake {
        0% { transform: translate(1px, 1px) rotate(0deg); }
        10% { transform: translate(-1px, -2px) rotate(-1deg); }
        20% { transform: translate(-3px, 0px) rotate(1deg); }
        30% { transform: translate(3px, 2px) rotate(0deg); }
        40% { transform: translate(1px, -1px) rotate(1deg); }
        50% { transform: translate(-1px, 2px) rotate(-1deg); }
        60% { transform: translate(-3px, 1px) rotate(0deg); }
        70% { transform: translate(3px, 1px) rotate(-1deg); }
        80% { transform: translate(-1px, -1px) rotate(1deg); }
        90% { transform: translate(1px, 2px) rotate(0deg); }
        100% { transform: translate(1px, -2px) rotate(-1deg); }
      }
</style>
{% endblock %}

{% block sidebarleft %}
<div class="list-group border-0 rounded-0 text-sm-start min-vh-100 border-end" >
    <div class="list-group-item border-end-0 d-inline-block">
        <label for="osm_tile_lang">map language:</label>
        <select class="form-select form-select-sm" aria-label="OSM language" id="osm_tile_lang">
            <option value="https://tile.openstreetmap.de/{z}/{x}/{y}.png" selected>german</option>
            <option value="https://tile.openstreetmap.org/{z}/{x}/{y}.png">english</option>
        </select>
    </div>

    <div class="list-group-item border-end-0 d-inline-block">
        <span>Download Infomation as GPX Waypoint Track (hidden POIs will be excluded!)</span>
            <form method="POST" action="/gpxtrack/{{object.slug}}/download">
                {% csrf_token %}
                <input type="hidden" name="slug" value="{{object.slug}}"/>
                <select name="waypoint_types" class="form-select-sm" multiple aria-label="Multiple select example">
                    {% for waypoint_type in object.get_waypoint_types %}
                    <option selected value="{{waypoint_type.pk}}">{{waypoint_type.name }}</option>
                    {% endfor %}
                </select>
                <div class="col-12">
                    <button type="submit" class="btn btn-primary">Download Waypoints</button>
                </div>
            </form>
    </div>

</div>
{% endblock%}

{% block sidebarright %}
<div>
    <div class="offcanvas-body">
    <small>
    You can split your track into segments to download it to your garmin or plan your tour.
    </small>
    <br/>
        <div id="sidebar_split_track">
        </div>
    </div>
</div>
{% endblock%}


{% block content %}
{% load static %}
<script type="text/javascript" src="{% static '/js/d3-7.8.5.js' %}"></script>
<script type="text/javascript" src="{% static 'js/gpx-viewr.js' %}"></script>

<main class="col ps-md-2 pt-2">
    <div class="page-header pt-3">
        <h2>{{object.name }}</h2>
        <div style="float:right;">
            <a class="nolinkcolor" href="#" title="Click on map and open location in OpenStreetMap">
                <img id="map_query_openstreetmap" width="20px" height="20px" src="{% static 'img/openstreetmap_logo.svg' %}"/>
            </a>
            |
            <a class="nolinkcolor" href="#" title="Click on map and open location in Google Maps">
                <img id="map_query_google_maps" width="20px" height="20px" src="{% static 'bootstrap-icons-1.11.2/google.svg' %}"/>
            </a>
            |
            <span id="elevation_tab_previous" class="collapse">
                <a class="nolinkcolor" href="#">
                    <img width="25px" height="25px" src="{% static 'bootstrap-icons-1.11.2/arrow-left.svg' %}"/>
                </a>
            </span>
            <a class="nolinkcolor" href="#" title="show/hide elevation graph">
                <img id="elevation_hide_show" class="animated shake" width="25px" height="25px" src="{% static 'bootstrap-icons-1.11.2/graph-up.svg' %}"/>
            </a>
            <span id="elevation_tab_next" class="collapse">
                <a class="nolinkcolor" href="#">
                    <img width="25px" height="25px" src="{% static 'bootstrap-icons-1.11.2/arrow-right.svg' %}"/>
                </a>
            </span>
        </div>
    </div>

    {% if object.get_job_status == 'error' %}
    <div class="alert alert-danger" role="alert">
        Job is in status error - ask on GitHub for help! :-(
    </div>
    {% endif %}

    {% if object.job_is_finished == False and object.get_job_status != 'error' %}
    <div class="alert alert-warning" role="alert">
    <div class="spinner-border text-primary" role="status">
    </div>
    <span id="job_status_info_box" style="padding-left:10px;">wating for job status</span>
    <script>
        var job_status_interval;
        var job_status_url = "/api/gpxfile/{{ object.slug }}/job_status/";

        function check_job_status() {
            var job_status_request = new XMLHttpRequest();
            job_status_request.open('POST', job_status_url);

            job_status_request.addEventListener('load', function(event) {
                var job_status_info_box = document.querySelector("#job_status_info_box")

                var d = JSON.parse(job_status_request.responseText);
                if (d["finished"] == true || d["job_status_name"] == 'error') {
                    clearInterval(job_status_interval);
                    location.reload();
                }
                else {
                    if (d["job_status_name"] == 'gpx_track_loading') {
                        job_status_info_box.innerHTML = "GPX Track is processing";
                    }
                    else if (d["job_status_name"] == 'osm_query') {
                        job_status_info_box.innerHTML = "OpenStreetMap Query is in progress...";
                    }
                }
            });
            job_status_request.send();
        }
        job_status_interval = setInterval(check_job_status, 500);
    </script>
    </div>
    {% endif %}

    <div id="map" style="width: 100%; height: 200px;"></div>

    <div id="map_query_google_maps_info_message_box" class="mt-4 p-5 bg-primary text-white rounded flyover flyover-centered">
        Click on map to open this location in Google Maps.
    </div>

    <div id="map_query_opensteetmap_info_message_box" class="mt-4 p-5 bg-primary text-white rounded flyover flyover-centered">
        Click on map to open this location in OpenStreetMap.
    </div>
   
</main>

<script>
    document.getElementById('map').style.height = window.innerHeight - 200 + "px";

    const gpx_file_slug = '{{object.slug}}';
    const map = L.map('map').setView([51.505, 10.09], 3);
    const tiles = L.tileLayer('https://tile.openstreetmap.de/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(map);

    document.querySelector("#osm_tile_lang").addEventListener("change", (event) => {
        tiles.setUrl(event.target.value);
    });

    L.Control.ElevationContainer = L.Control.extend({
        options: {
            position: "topright",
            width: 500,
            height: 240,
        },
        onAdd: function(map) {
            this.map = map;
            var div = L.DomUtil.create('div');
            div.id = "map_elevation";
            div.classList.add("map_elevation");

            var tab = document.createElement("div");
            tab.className = "tab-content";
            tab.id = "map_elevation_tabs";

            div.appendChild(tab);

            return div;
        }
    });
    L.Control.elevation = function(opts) {
        return new L.Control.ElevationContainer(opts);
    }
    L.Control.elevation().addTo(map);


    d3.json('/api/gpxfile/' + gpx_file_slug + '/json').then(function (data) {
        var index = 0;
        var active_tab = true;
        data.forEach(track => {
            track.segments.forEach(segment => {
                var f = new TrackSegment(gpx_file_slug, segment.segment_id, map, segment, track.name, active_tab, index);
                active_tab = false;
            });
            index += 1;
        });
        if (index > 1) {
            L.DomUtil.get('elevation_tab_previous').classList.remove("collapse");
            L.DomUtil.get('elevation_tab_next').classList.remove("collapse");
        }
    });

    var split_track_menu = new SplitTrackMenu(gpx_file_slug, map, "sidebar_split_track");
    split_track_menu.get_data();

    var waypoints = new Waypoints(gpx_file_slug, map);
    waypoints.get_data();

    var map_query_google_maps = new MapQueryGoogleMaps(map);  
    var map_query_openstreetmap = new MapQueryOpenStreetMap(map);

    user_segment_split = new UserSegmentSplit(gpx_file_slug, map);


    document.querySelector("#elevation_hide_show").addEventListener("click", (event) => {
        var w = L.DomUtil.get("map_elevation_tabs");
        if (w.classList.contains('collapse')) {
            w.classList.remove('collapse');
        }
        else {
            w.classList.add('collapse');
        }
    });
    document.querySelector("#elevation_tab_next").addEventListener("click", (event) => {
        var tab = document.querySelector("#map_elevation_tabs");
        var tabs = tab.querySelectorAll(".tab-pane");
        for (var i = 0, length = tabs.length; i < length; i++) {
            if (tabs[i].classList.contains('active')) {
                tabs[i].classList.remove('active');
                if (i == tabs.length - 1) {
                    tabs[0].classList.add('active');
                }
                else {
                    tabs[i + 1].classList.add('active');
                }
                break;
            }
        }
    });
    document.querySelector("#elevation_tab_previous").addEventListener("click", (event) => {
        var tab = document.querySelector("#map_elevation_tabs");
        var tabs = tab.querySelectorAll(".tab-pane");
        for (var i = 0, length = tabs.length; i < length; i++) {
            if (tabs[i].classList.contains('active')) {
                tabs[i].classList.remove('active');
                if (i == 0) {
                    tabs[length - 1 ].classList.add('active');
                }
                else {
                    tabs[i - 1].classList.add('active');
                }
                break;
            }
        }
    });

    function hide_elevation_graph() {
        var w = L.DomUtil.get("map_elevation_tabs");
        w.classList.add('collapse');

        var e = L.DomUtil.get("elevation_hide_show");
        e.classList.add("elevation_hide_show_shake");

    }
    // show the elevation graph and then hide it after 1s
    setTimeout(hide_elevation_graph, 1500);

</script>
{% endblock %}
